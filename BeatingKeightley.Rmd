---
title: "Beating Keightley"
output: html_notebook
---

This NoteBook is to look at beating our current rental situation

# Libraries
```{r}
library(dplyr)
library(ggplot2)
```
# Functions
```{r}
Transaction_Cost <- function(price) {
  MortgageRegistration <- 178.20
  LandTransferFee <- 178.20
  
  if (price > 85000 & price < 120000){
    LandTransferFee <- 188.2
  }else{
    LandTransferFee <- 188.2 + floor(price / 100000)*20
  }
  
  StampDuty <- 0
  
  if (price > 430000 & price < 530000) {
    StampDuty = 19.19 * (price-430000)/100
  } else if (price > 530000 & price < 750000) {
    StampDuty = 11115 + 4.75*(price-360000)/100 
  } else if (price >= 750000) {
    StampDuty = 28453 + 5.15*(price-725000)/100
  }
  
  tax = MortgageRegistration + LandTransferFee + StampDuty
  
  return(tax)
}

TrueDeposit <- function(price,deposit){
  return (deposit - Transaction_Cost(price))
}

LoanValueRatio <- function(price,deposit){
  return((price-TrueDeposit(price,deposit))/price)
}

LenderMortgageInsurance <- function(price,deposit){
  lvr <- round(LoanValueRatio(price,deposit),digits = 2)
  LMI_rate <- 0
  rates <- read.csv('LMI_RATES.csv')
  wa_stamp_duty <- 0.1
  GST <- 0.1
  
  if(lvr > 0.8) {
    LMI_rate <- case_when(
      price <= 300000 ~ rates %>% filter(LVR == lvr) %>% select(X0) %>% pull(),
      price > 300000 & price <= 500000 ~ rates %>% filter(LVR == lvr) %>% select(X300000) %>% pull(),
      price > 500000 & price <= 600000 ~ rates %>% filter(LVR == lvr) %>% select(X500000) %>% pull(),
      price > 600000 & price <= 750000 ~ rates %>% filter(LVR == lvr) %>% select(X600000) %>% pull(),
      TRUE ~ rates %>% filter(LVR == lvr) %>% select(X750000) %>% pull()
    )
  }
  LMI <- price*LMI_rate
  LMI_Net <- LMI + LMI*wa_stamp_duty
  LMI_FINAL <- LMI_Net + LMI_Net*GST
  return(LMI_FINAL)
}

TrueMortgageValue <- function(price,deposit){
  return(price - TrueDeposit(price,deposit) + LenderMortgageInsurance(price,deposit))
}

TotalInterests <- function(value,rate,term){
  return(value*rate*(term/12))
}

MinMonthlyRepayment <- function(value,rate,term){
  return((value + TotalInterests(value,rate,term))/term)
}

PrincipalMonthlyRepayment <-  function(value,term){
  return(value/term)
}

InterestMonthlyRepayment <- function(value,rate,term){
  return(MinMonthlyRepayment(value,rate,term)-PrincipalMonthlyRepayment(value,term))
}

MortgageCost <- function(value,rate,MaxMonthlyRepayment,term){
  Costs <- data.frame(0,0,value)
  names(Costs)<-c("Date","Cost","Principal")
  mortgage <- value
  timeleft <- term*12
  time <- 0
  cost <- 0
  while (mortgage > 0){
    if(MaxMonthlyRepayment < MinMonthlyRepayment(mortgage,rate,timeleft)) stop('Monthly Repayments do not meet minimum requierements')
    mortgage <- mortgage - (MaxMonthlyRepayment - InterestMonthlyRepayment(mortgage,rate,timeleft))
    cost <- InterestMonthlyRepayment(mortgage,rate,timeleft)
    timeleft <-  timeleft - 1
    time <- time +1
    monthly_cost <- data.frame(time,cost,mortgage)
    names(monthly_cost)<-c("Date","Cost","Principal")
    Costs <- rbind(Costs,monthly_cost)
  }
  return(Costs)
}

Depreciation <- function(value,rate){
  return(value*rate)
}

Maintenance <- function(value,rate,time){
  return(value*rate*time)
}

SalesAgentCost <- function(value){
  return(value * 0.03)
}

BuyingVSRenting <- function(House_Price,Deposit,Rate,Max_Monthly_Repayment,Term,HousePriceVariation,MaintenanceRate,Fixed_Yearly_Rates){
  myMortgage <- MortgageCost(TrueMortgageValue(House_Price,Deposit),Rate,Max_Monthly_Repayment,Term)
  MaxOwnershipTime <- max(myMortgage$Date)/12
  OwnershipTime <- 1
  WeeklyCost <- data.frame(0,0,'Yes')
  names(WeeklyCost)<-c("Year","CostsAsWeeklyRent","MoreExpensiveThenCurrentRent")
  
  while (OwnershipTime <= MaxOwnershipTime){
    myMortgage_short <- myMortgage %>% filter(Date < OwnershipTime*12)
    Total_Cost <- sum(myMortgage_short$Cost) +
                  Transaction_Cost(House_Price) +
                  Depreciation(House_Price,HousePriceVariation) + 
                  Maintenance(House_Price,MaintenanceRate,OwnershipTime) +
                  SalesAgentCost(House_Price - Depreciation(House_Price,HousePriceVariation)) +
                  Fixed_Yearly_Rates*OwnershipTime
                  
    CostsAsWeeklyRent <-  Total_Cost/(OwnershipTime*12*4)
    
    MoreExpensive <- if(CostsAsWeeklyRent<Current_Rent) 'No' else 'Yes' 
    
    weekly_cost <- data.frame(OwnershipTime,CostsAsWeeklyRent,MoreExpensive)
    names(weekly_cost)<-c("Year","CostsAsWeeklyRent","MoreExpensiveThenCurrentRent")
    
    WeeklyCost <- rbind(WeeklyCost,weekly_cost)
    
    OwnershipTime = OwnershipTime + 1
    
  }
  
  ggplot(WeeklyCost %>% filter(Year > 0),aes(Year,CostsAsWeeklyRent,fill = MoreExpensiveThenCurrentRent)) +geom_col()
}

```

# Run The Model

```{r}
House_Price <- 600000

Current_Rent <- 680

Deposit <- 135000

Max_Monthly_Repayment <- 4000

Rate <- 0.04

Term <- 30

Council_Rate <- 1600

Water_Rate <- 1020

Strata <- 0

HousePriceVariation <- 0.01

MaintenanceRate <-           0.01

Fixed_Yearly_Rates <- Council_Rate + Water_Rate + Strata

BuyingVSRenting(House_Price,Deposit,Rate,Max_Monthly_Repayment,Term,HousePriceVariation,MaintenanceRate,Fixed_Yearly_Rates)

```
